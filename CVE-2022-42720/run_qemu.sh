#!/usr/bin/env bash
##### Find and emulate the corresponding Linux kernel image and hard drive with QEMU.

kernel=$(find . -name "bzImage" 2>/dev/null | head -n 1)
if [[ ${kernel} == "" ]]; then
    echo "No 'bzImage' kernel file was found!"
    exit 1
fi

disk=$(find . -name "stretch.img" 2>/dev/null | head -n 1)
if [[ ${disk} == "" ]]; then
    echo "No 'stretch.img' hard drive file was found!"
    exit 1
fi

echo "All required artifact files were found!"
echo "Running Linux kernel ${kernel} and ${disk} hard drive with QEMU."

qemu-system-x86_64 \
	-m 2G \
	-kernel ${kernel} \
	-append "console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0 nokaslr" \
	-drive file=${disk},format=raw \
	-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
	-net nic,model=e1000 \
	-nographic
